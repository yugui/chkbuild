#!/usr/bin/env ruby

require 'chkbuild'
require 'chkbuild/ruby'

ChkBuild.limit(:data=>1024*1024*300, :as=>1024*1024*300)

def modify_file(filename)
  content = yield File.read(filename)
  open(filename, "w") {|f|
    f.print content
  }
end

Autoconf = ChkBuild.def_target("autoconf") {|b|
  dir = b.build_dir
  Dir.chdir("..") {
    b.gnu_savannah_cvs('autoconf', 'autoconf', nil)
  }
  b.mkcd("objdir")
  b.run("../../autoconf/configure", "--prefix=#{dir}")
  # modify Makefile to not use help2man.
  modify_file("Makefile") {|content|
    content.sub(/^SUBDIRS\s*=.*$/) { $&.sub(/ man /, ' ') }
  }
  b.make
  b.make("install")

  b.run("#{dir}/bin/autoconf", '--version', :section=>'version')
}

Autoconf.add_title_hook('version') {|title, log|
  case log
  when /^Autoconf version (.*)$/
    title.update_title(:version, "autoconf #{$1}")
  when /^autoconf \(GNU Autoconf\) (.*)$/
    title.update_title(:version, "autoconf #{$1}")
  end
}

def_build_ruby(
  ["trunk", "1.8"],
  Autoconf,
  :separated_srcdir => true)

ChkBuild.main
