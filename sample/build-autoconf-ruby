#!/usr/bin/env ruby

require 'build'
require 'chkbuild/ruby'

Build.limit(:data=>1024*1024*300, :as=>1024*1024*300)

def modify_file(filename)
  content = yield File.read(filename)
  open(filename, "w") {|f|
    f.print content
  }
end

Autoconf = Build.def_perm_target("autoconf") {|b|
  dir = b.work_dir
  Dir.chdir("..") {
    Build.gnu_savannah_cvs('autoconf', 'autoconf', nil)
  }
  Build.mkcd("objdir")
  Build.run("../../autoconf/configure", "--prefix=#{dir}")
  # modify Makefile to not use help2man.
  modify_file("Makefile") {|content|
    content.sub(/^SUBDIRS\s*=.*$/) { $&.sub(/ man /, ' ') }
  }
  Build.make
  Build.make("install")
  Build.run("#{dir}/bin/autoconf", '--version', :section=>'version') {|log|
    case log
    when /^Autoconf version (.*)$/
      b.update_title(:version, "autoconf #{$1}")
    when /^autoconf \(GNU Autoconf\) (.*)$/
      b.update_title(:version, "autoconf #{$1}")
    end
  }
}

def_build_ruby2(
  ["trunk", "1.8"],
  Autoconf)

Build.main
